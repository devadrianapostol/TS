<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <title>Tehnici de simulare</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
</head>
<body >
<header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="index.html">Tehnici de Simulare</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-source="normal.html" href="normal.html">Normala(0.2,3)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" data-source="poisson.html" href="poisson.html">Poisson</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
<div class="main container-fluid" style="min-height: 80%;">
    <div class="row">
        <div class="col-lg-2 mt-4">
            <div class=" border bg-light p-2">
                <div >Media empirica selectie: <span id="mediaESelectie" style="font-weight: bold"></span> </div>
                <div >Dispersia empirica selectie: <span id="dispersiaESelectie" style="font-weight: bold"></span></div>
                <div>nr de variabile = <span id="nrdevariabile" style="font-weight: bold"></span></div>
            </div>
            <div class="bg-light border p-2 mb-4 mt-4" style="max-height: 90vh;overflow: auto;"><strong>Frecventele Poisson generate:</strong> :
                <div id="rezultat">

                </div>
            </div>
        </div>
        <div class="col-lg-8 ">
            <div class="mt-4">
                <h3 class="">Poisson</h3>
                <figure class="highcharts-figure">
                    <div id="container"></div>
                </figure>
            </div>

            <div class=" mb-4">
                <div class="mb-4">
                    <h6>Alege algoritm</h6>
                    <select id="selectPoisson" class="">
                        <option value="poisson1">Poisson 1</option>
                        <option value="poisson2">Poisson 2</option>
                    </select>
                </div>
                <div class="input-group mb-3 mt-4">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Nr maxim de variabile</span>
                    </div>
                    <input type="number" id="nrmaxvar" class="form-control" aria-label="lambda" aria-describedby="basic-addon1" value="1000">
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Min</span>
                    </div>
                    <input type="number" id="min" class="form-control" aria-label="lambda" aria-describedby="basic-addon1" value="0">
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Max</span>
                    </div>
                    <input type="number" id="max" class="form-control" aria-label="lambda" aria-describedby="basic-addon1" value="100">
                </div>
                <div class="poisson1 algoritm bg-light border p-4" >
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">Lambda</span>
                        </div>
                        <input type="number" id="lambda1" class="form-control" aria-label="lambda" aria-describedby="basic-addon1" value="0">
                    </div>
                    <div class="mt-4 mb-4">
                        <h5>Algoritm Poisson1</h5>
                        <br>Intrare: λ,i:= 0,P= 1;

                        <br>P1:  Se genereaza U∼U(0,1), i:=i+ 1,P:=P∗U;
                        <br>P2:  Daca P≥e^−λ atunci mergi la P1, altfel mergi la P3;
                        <br>P3:X:=i−1.

                        <br>Iesire:Variabila aleatoare X.
                    </div>
                </div>
                <div class="poisson2 algoritm bg-light border p-2" >
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">Lambda</span>
                        </div>
                        <input type="number" id="lambda2" class="form-control" aria-label="lambda" aria-describedby="basic-addon1" value="0">
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">P=</span>
                        </div>
                        <input type="number" id="p" class="form-control" aria-label="p" aria-describedby="basic-addon1" value="0.001">
                    </div>

                    <div class="mt-4 mb-4">
                        <h5>Algoritm Poisson2</h5>
                        <br>Intrare: λ, se alege p≈0, de exemplu p= 0.001;
                        <br>P1: Se determina n= cel mai apropiat ıntreg de λ/p;
                        <br>P2:  Se genereaza X∼Binom(n,p);
                        <br>Iesire: Variabila aleatoare X
                    </div>
                </div>

            </div>
        </div>
        <div class="col-lg-2 mt-4">
            <div class="input-group mb-3">
                <div>Alege tip harta: </div>
                <select id="selectTipVizualizare" class="ml-4">
                    <option value="line" selected>Linie</option>
                    <option value="histogram">Histograma</option>
                </select>
            </div>
            <button class="btn btn-primary" id="genereaza" type="button">Genereaza</button>
        </div>
    </div>


</div>

<footer id="footer" class="footer-1 bg-dark">
    <div class="main-footer text-light">
        <div class="container">
            <div class="row">

                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="widget subscribe no-box  text-light">
                        <h5 class="widget-title">Adrian Apostol<span></span></h5>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
    $(document).ready(function(){
        function genereaza(l, algoritm, p){
            let numarVariabile = $("#nrmaxvar").val() || 1000;
            let step = 1;
            let max = parseInt($("#max").val()) || 15;
            let min = parseInt($("#min").val()) || 0;
            let data = {};
            let dataMediaEmpirica = [];

            const round_to_precision = (x, precision) => {
                var y = +x + (precision === undefined ? 0.5 : precision/2);
                return y - (y % (precision === undefined ? 1 : +precision));
            }

            const poisson1 = (lambda) => {
                // Intrare: λ,i:= 0,P= 1;
                let i = 0;
                let P = 1;
                let L = Math.pow(Math.E, -lambda);
                //P1:  Se genereaza U∼U(0,1), i:=i+ 1,P:=P∗U;
                //P2:  Daca P≥e^−λ atunci mergi la P1, altfel mergi la P3
                //let U = Math.random();
                do {
                    i += 1;
                    U = Math.random();
                    P *= U;
                } while (P >= L)

                //P3:X:=i−1.
                let X = i -1;
                return X;
            };

            const bern = (p) => {
                let q = 1-p;
                // Intrare:p
                // P1:  Se genereaz U∼U(0,1);
                let U = Math.random();
                let Z;
                if(U <= q){
                    Z = 0;
                } else {
                    Z = 1;
                }
                // P2:  Daca U≤q atunci Z= 0, altfel Z= 1;
                // Iesire:Variabila aleatoare Z.
                return Z;
            };

            const binom = (n, O) => {
                // Intrare:n,p
                // P1:i= 1,X= 0;
                let i = 1;
                let X = 0;

                // P2:  Se genereaza Zi∼Bern(p),X:=X+Zi;
                let Zi = bern(p);
                X = X+Zi;

                while (i !== n){
                    i = i + 1;
                    let Zi = bern(p);
                    X = X+Zi;
                }
                return X;
                // P3:  Daca i=n stop, altfel i:=i+ 1, mergi la P2;
                // Iesire: Variabila aleatoare X.
            };

            const poisson2 = (lambda, p) => {
                //Intrare: λ, se alege p≈0, de exemplu p= 0.001;
                // P1: Se determina n= cel mai apropiat ıntreg de λ/p;
                let n = Math.round(lambda / p);

                return binom(n,p, 1, 0);
                // P2:  Se genereaza X∼Binom(n,p);
                // Iesire: Variabila aleatoare X

            }

            // Seed data with a bunch of 0s
            for (let j=min; j<= max; j+=step) {
                data[j] = 0;
            }

            // Create n samples between min and max
            for (i=0; i<numarVariabile; i+=step) {
                let rand_num = 0;
                if(algoritm === "poisson1"){
                    rand_num = poisson1( l);// Translate to 0 -> 1
                } else if(algoritm === "poisson2") {
                    rand_num = poisson2(l, p);
                } else {
                    continue;
                }

                let rounded = round_to_precision(rand_num, step);
                dataMediaEmpirica.push(rounded);
                data[rounded] += 1;
            }


            let hc_data = [];
            for (const [key, val] of Object.entries(data)) {
                hc_data.push({"x": parseFloat(key), "y": val/numarVariabile});
            }

            // Sort
            hc_data = hc_data.sort(function(a, b){
                if(a.x < b.x) return -1;
                if(a.x > b.x) return 1;
                return 0;
            });

            Highcharts.chart('container', {

                title: {
                    text: ''
                },

                yAxis: {
                    title: {
                        text: 'Probabilitate'
                    }
                },

                xAxis: {
                    ordinal: false
                },

                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },

                plotOptions: {
                },

                series: [
                    {
                        name: 'Probabilitate Poisson',
                        data: hc_data,
                        color: "rgba(0, 140, 255, 0.3)",
                        //type: "scatter"
                        type: $("#selectTipVizualizare").val() || 'histogram',
                    }
                ],

                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }

            });

            let Xb = (dataMediaEmpirica.reduce((acc, nr) => {
                if(isNaN(parseFloat(nr))) return acc;
                return acc + nr;
            }, 0) / dataMediaEmpirica.length ) || [].length;

            let Xi2 = dataMediaEmpirica.reduce((acc, nr) => {
                if(isNaN(parseFloat(nr))) return acc;
                return acc + Math.pow(nr, 2);
            }, 0) || [].length;

            let s2 = ( Xi2 / dataMediaEmpirica.length) - Math.pow(Xb, 2) || 0;
            let nrVarGenerate = Object.keys(data).reduce((acc, k) => parseInt(data[k]) > 0 ? acc + data[k] : acc, 0 );
            $("#mediaESelectie").text(Xb.toPrecision(2));
            $("#dispersiaESelectie").text(s2.toPrecision(2));
            $("#nrdevariabile").text(nrVarGenerate);

            return data;
        }

        $(".algoritm").hide();
        $(".poisson1").show();

        $("#selectPoisson").on("change", (e) => {
            let v = $(e.target).val();
            $(".algoritm").hide();
            $("." + v).show();
        });

        $("#genereaza").on("click", function (e){
            let m = $("#selectPoisson").val();
            if(m.length === 0){
                return;
            }

            if(m === "poisson1"){
                let lambda1 = parseFloat($("#lambda1").val());
                if(lambda1){
                    let res = genereaza(lambda1, "poisson1", null);
                    let nrVarGenerate = Object.keys(res).reduce((acc, k) => parseInt(res[k]) > 0 ? acc + res[k] : acc, 0 );
                    let data = Object.keys(res).map((k) => {
                        if(isNaN(res[k])) return "";
                       return k + "->" + + ( res[k] / nrVarGenerate );
                    });

                    $("#rezultat").html(data.join("<br>"));
                }
            }
            if(m === "poisson2"){
                let p = parseFloat($("#p").val());
                let lambda2 = parseFloat($("#lambda2").val());
                if(p && lambda2){
                    let res = genereaza(lambda2, "poisson2", p);
                    let nrVarGenerate = Object.keys(res).reduce((acc, k) => parseInt(res[k]) > 0 ? acc + res[k] : acc, 0 );
                    let data = Object.keys(res).map((k) => {
                        if(isNaN(res[k])) return "";
                        return k + "->" + ( res[k] / nrVarGenerate );
                    });
                    $("#rezultat").html(data.join("<br>"));
                }
            }
        });

        genereaza(0);

    });

</script>
</body>
</html>